# –§–∏–Ω–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å amoCRM —á–µ—Ä–µ–∑ Wahelp

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

1. ‚úÖ –ö–ª–∏–µ–Ω—Ç –ø–∏—à–µ—Ç –≤ –±–æ—Ç–∞ (–Ω–µ –≤ amoCRM –Ω–∞–ø—Ä—è–º—É—é)
2. ‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ, –∑–∞–ø—Ä–æ—Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞, –±–æ–Ω—É—Å—ã
3. ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥/–∫–Ω–æ–ø–æ–∫ (–≤–æ–ø—Ä–æ—Å—ã, –∑–∞–∫–∞–∑—ã, –ø—Ä–∞–π—Å, –±–æ–Ω—É—Å—ã, —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã)
4. ‚úÖ –ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –≤ amoCRM —á–µ—Ä–µ–∑ Wahelp
5. ‚úÖ –û—Ç–≤–µ—Ç—ã –∏–∑ amoCRM ‚Üí –ø–µ—Ä–µ—Å—ã–ª–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—É –≤ –±–æ—Ç
6. ‚úÖ –í–æ –≤—Ä–µ–º—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏ —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã (—Ä–µ—à–∞–µ—Ç—Å—è —ç–º–æ–¥–∑–∏ –ø–µ—Ä–µ–¥ –∫–Ω–æ–ø–∫–∞–º–∏)

---

## –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

### 1. –ö–æ–º–∞–Ω–¥—ã –∏ –∫–Ω–æ–ø–∫–∏ (–ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ amoCRM)

**–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–æ–¥–æ–º:**
- `/start` - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
- –ö–Ω–æ–ø–∫–∏: "–ú–æ–∏ –±–æ–Ω—É—Å—ã", "–°–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑", "–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å", "üí∞ –ü—Ä–∞–π—Å", "üïê –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã"
- –°–æ—Å—Ç–æ—è–Ω–∏—è FSM: `waiting_question`, `waiting_order`, `waiting_phone_manual`

**–ß—Ç–æ –¥–µ–ª–∞–µ–º:**
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–æ–¥–æ–º
- –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∞–º (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
- –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Wahelp/amoCRM

### 2. –ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ amoCRM)

**–ö–æ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º:**
- –ö–ª–∏–µ–Ω—Ç –Ω–∞–ø–∏—Å–∞–ª –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç
- –ù–ï –∫–æ–º–∞–Ω–¥–∞ (`/start`, `/info`, `/cancel`)
- –ù–ï –∫–Ω–æ–ø–∫–∞ (–Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–µ–∫—Å—Ç–æ–º –∫–Ω–æ–ø–æ–∫)
- –ù–ï –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ FSM (–Ω–µ `waiting_question`, `waiting_order`, `waiting_phone_manual`)

**–ß—Ç–æ –¥–µ–ª–∞–µ–º:**
- –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Wahelp (–∫–∞–Ω–∞–ª `clients_tg`)
- Wahelp –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—à–ª—ë—Ç –≤ amoCRM
- –ú–µ–Ω–µ–¥–∂–µ—Ä –≤–∏–¥–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ amoCRM –∏ –º–æ–∂–µ—Ç –æ—Ç–≤–µ—Ç–∏—Ç—å

### 3. –û—Ç–≤–µ—Ç—ã –∏–∑ amoCRM (–ø–µ—Ä–µ—Å—ã–ª–∞–µ–º –∫–ª–∏–µ–Ω—Ç—É)

**–ö–æ–≥–¥–∞ –ø–æ–ª—É—á–∞–µ–º:**
- –ß–µ—Ä–µ–∑ Wahelp webhook
- `destination = "from_operator"` ‚Üí –æ—Ç–≤–µ—Ç –æ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞

**–ß—Ç–æ –¥–µ–ª–∞–µ–º:**
- –ü–µ—Ä–µ—Å—ã–ª–∞–µ–º –∫–ª–∏–µ–Ω—Ç—É –≤ Telegram
- –ù–ï –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–æ–¥–æ–º

---

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### –®–∞–≥ 1: –î–æ–±–∞–≤–∏—Ç—å –º–æ–¥—É–ª—å Wahelp

–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏–∑ –∞–¥–º–∏–Ω-–±–æ—Ç–∞:
- `crm/wahelp_client.py` - –∫–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Wahelp API
- `crm/wahelp_service.py` - —Å–µ—Ä–≤–∏—Å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

### –®–∞–≥ 2: –û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ Wahelp

–î–æ–±–∞–≤–∏—Ç—å –≤ fallback handler:

```python
@dp.message(F.text)
async def fallback(message: Message, state: FSMContext):
    # –ï—Å–ª–∏ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ FSM - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∫ –æ–±—ã—á–Ω–æ
    if await state.get_state():
        await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≤–µ—Ä—à–∏—Ç–µ —Ç–µ–∫—É—â–∏–π —à–∞–≥ –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ ¬´–û—Ç–º–µ–Ω–∞¬ª.")
        return
    
    # –ï—Å–ª–∏ —ç—Ç–æ –∫–æ–º–∞–Ω–¥–∞ –∏–ª–∏ –∫–Ω–æ–ø–∫–∞ - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∫ –æ–±—ã—á–Ω–æ
    if is_command_or_button(message.text):
        await handle_command_or_button(message, state)
        return
    
    # –ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ amoCRM
    client = await get_client_by_tg(message.from_user.id)
    if client and client.get("phone"):
        await send_to_wahelp(
            phone=client["phone"],
            name=client.get("full_name"),
            text=message.text,
            channel="clients_tg"
        )
        await message.answer("–°–æ–æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–µ–¥–∞–Ω–æ –º–µ–Ω–µ–¥–∂–µ—Ä—É. –û—Ç–≤–µ—Ç–∏–º –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.")
    else:
        await message.answer("–°–Ω–∞—á–∞–ª–∞ –Ω—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞.")
```

### –®–∞–≥ 3: –ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤ —á–µ—Ä–µ–∑ Wahelp webhook

–ù–∞—Å—Ç—Ä–æ–∏—Ç—å webhook —Å–µ—Ä–≤–µ—Ä:

```python
async def handle_wahelp_inbound(payload: dict) -> bool:
    data = payload.get("data", {})
    destination = str(data.get("destination") or data.get("direction") or "").lower()
    
    # –¢–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç—ã –æ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞
    if destination not in {"from_operator", "operator"}:
        return False
    
    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω –∏ —Ç–µ–∫—Å—Ç
    phone = extract_phone_from_payload(data)
    text = extract_text_from_payload(data)
    
    if not phone or not text:
        return False
    
    # –ù–∞—Ö–æ–¥–∏–º –∫–ª–∏–µ–Ω—Ç–∞
    client = await get_client_by_phone(phone)
    if not client or not client.get("bot_tg_user_id"):
        return False
    
    # –ü–µ—Ä–µ—Å—ã–ª–∞–µ–º –∫–ª–∏–µ–Ω—Ç—É
    await bot.send_message(client["bot_tg_user_id"], text)
    return True
```

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–∞–Ω–¥ –∏ –∫–Ω–æ–ø–æ–∫

```python
def is_command_or_button(text: str) -> bool:
    # –ö–æ–º–∞–Ω–¥—ã
    if text.startswith("/"):
        return True
    
    # –ö–Ω–æ–ø–∫–∏ (—Å —ç–º–æ–¥–∑–∏ –∏–ª–∏ –±–µ–∑)
    buttons = [
        "–ú–æ–∏ –±–æ–Ω—É—Å—ã",
        "–°–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑",
        "–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å",
        "üí∞ –ü—Ä–∞–π—Å",
        "üïê –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã",
        "üì± –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –Ω–æ–º–µ—Ä–æ–º",
        "–û—Ç–º–µ–Ω–∞",
    ]
    
    text_normalized = text.strip()
    for button in buttons:
        # –£–±–∏—Ä–∞–µ–º —ç–º–æ–¥–∑–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
        button_text = button.split(" ", 1)[-1] if " " in button else button
        if text_normalized.lower() == button.lower() or text_normalized.lower() == button_text.lower():
            return True
    
    return False
```

---

## –ü–æ—Ä—è–¥–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

### –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞:

1. **–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ FSM:**
   - –ï—Å–ª–∏ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ ‚Üí –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∫ –æ–±—ã—á–Ω–æ
   - –ï—Å–ª–∏ –Ω–µ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ ‚Üí –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º

2. **–ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–º–∞–Ω–¥—É/–∫–Ω–æ–ø–∫—É:**
   - –ï—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ ‚Üí –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–æ–¥–æ–º
   - –ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ ‚Üí –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–æ–¥–æ–º
   - –ï—Å–ª–∏ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Wahelp

3. **–û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Wahelp:**
   - –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Wahelp (–∫–∞–Ω–∞–ª `clients_tg`)
   - –£–≤–µ–¥–æ–º–ª—è–µ–º –∫–ª–∏–µ–Ω—Ç–∞

### –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞ –æ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞:

1. **–ü–æ–ª—É—á–∞–µ–º —á–µ—Ä–µ–∑ Wahelp webhook**
2. **–ü—Ä–æ–≤–µ—Ä—è–µ–º `destination = "from_operator"`**
3. **–ù–∞—Ö–æ–¥–∏–º –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É**
4. **–ü–µ—Ä–µ—Å—ã–ª–∞–µ–º –∫–ª–∏–µ–Ω—Ç—É –≤ Telegram**

---

## –ß—Ç–æ –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ amoCRM

- –ö–æ–º–∞–Ω–¥—ã (`/start`, `/info`, `/cancel`)
- –ö–Ω–æ–ø–∫–∏ ("–ú–æ–∏ –±–æ–Ω—É—Å—ã", "–°–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑", "–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å", "üí∞ –ü—Ä–∞–π—Å", "üïê –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã")
- –°–æ–æ–±—â–µ–Ω–∏—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ FSM (–≤–æ–ø—Ä–æ—Å, –∑–∞–∫–∞–∑, —Ç–µ–ª–µ—Ñ–æ–Ω)
- –°–æ–æ–±—â–µ–Ω–∏—è –±–µ–∑ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–ø—Ä–æ—Å–∏–º —É–∫–∞–∑–∞—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω)

---

## –ß—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ amoCRM

- –ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞
- –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —É–∫–∞–∑–∞–ª —Ç–µ–ª–µ—Ñ–æ–Ω
- –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –∫–æ–º–∞–Ω–¥–∞ –∏ –Ω–µ –∫–Ω–æ–ø–∫–∞

---

## –í–æ–ø—Ä–æ—Å—ã –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è

1. **–ß—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–∞–ø–∏—Å–∞–ª –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç –ë–ï–ó —Ç–µ–ª–µ—Ñ–æ–Ω–∞?**
   - –ü—Ä–æ—Å–∏—Ç—å —É–∫–∞–∑–∞—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω?
   - –ò–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –≤ amoCRM —Å –ø–æ–º–µ—Ç–∫–æ–π "—Ç–µ–ª–µ—Ñ–æ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω"?

2. **–ù—É–∂–Ω–æ –ª–∏ —É–≤–µ–¥–æ–º–ª—è—Ç—å –∫–ª–∏–µ–Ω—Ç–∞, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –º–µ–Ω–µ–¥–∂–µ—Ä—É?**
   - "–°–æ–æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–µ–¥–∞–Ω–æ –º–µ–Ω–µ–¥–∂–µ—Ä—É. –û—Ç–≤–µ—Ç–∏–º –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è."
   - –ò–ª–∏ –ø—Ä–æ—Å—Ç–æ –º–æ–ª—á–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å?

3. **–ö–∞–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –æ—Ç–≤–µ—Ç—ã –º–µ–Ω–µ–¥–∂–µ—Ä–∞, –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±–æ—Ç–∞?**
   - –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫—É?
   - –£–≤–µ–¥–æ–º–ª—è—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –≤ amoCRM?

