# Как работают Telegram боты и интеграция с amoCRM

## Как работают Telegram боты

### Два способа получения сообщений:

1. **Long Polling (опрос)** — бот сам спрашивает у Telegram:
   ```
   Бот → Telegram: "Есть новые сообщения?"
   Telegram → Бот: "Да, вот сообщение от клиента"
   ```
   - Используется: `await dp.start_polling(bot)`
   - Работает на любом сервере
   - Не нужен публичный URL

2. **Webhook (вебхук)** — Telegram сам отправляет сообщения:
   ```
   Клиент → Telegram → Ваш сервер (POST запрос)
   ```
   - Нужен публичный URL с SSL
   - Telegram отправляет POST при каждом сообщении
   - Быстрее, но сложнее настройка

---

## Встроенная интеграция amoCRM с Telegram ботами

### Как это работает:

amoCRM имеет встроенную интеграцию, которая работает так:

1. **Вы подключаете бота в настройках amoCRM**
   - Заходите в Настройки → Интеграции → Telegram боты
   - Указываете токен бота
   - amoCRM создаёт свой прокси-сервер

2. **Схема работы:**
   ```
   Клиент → Telegram → amoCRM прокси → amoCRM (показывает в интерфейсе)
   ```

3. **Особенности:**
   - ✅ Все сообщения автоматически попадают в чат с контактом
   - ✅ Можно отвечать прямо из amoCRM
   - ❌ НО: бот НЕ обрабатывает сообщения вашим кодом
   - ❌ Ваш бэкенд НЕ получает сообщения

---

## Почему перестало работать?

### Проблема:

Когда вы добавили свой бэкенд (`telegram-bot-client`), бот начал обрабатывать сообщения сам:

```python
# Ваш код обрабатывает сообщение
@dp.message(StateFilter(ClientRequestFSM.waiting_question))
async def handle_question_text(message: Message, state: FSMContext):
    # Сообщение обработано вашим кодом
    await notify_admins(payload)
    # НО сообщение НЕ попадает в amoCRM!
```

**Что происходит:**
- Telegram отправляет сообщение вашему боту
- Ваш код (`aiogram`) обрабатывает его
- Сообщение НЕ пересылается в amoCRM (потому что бот не проксирует)

### Почему раньше работало:

Когда бот был подключен только через встроенную интеграцию amoCRM:
- amoCRM получала все сообщения напрямую через свой прокси
- Показывала их в интерфейсе
- Можно было отвечать из amoCRM

---

## Решения

### ✅ Вариант 1: Отправлять сообщения в Wahelp (рекомендуется)

У вас уже есть интеграция с Wahelp, который подключен к amoCRM.

**Как это работает:**
```
Клиент → Ваш бот → Wahelp API → amoCRM
```

**Что нужно сделать:**
1. При получении сообщения от клиента
2. Отправить его в Wahelp через API (канал `clients_tg`)
3. Wahelp автоматически перешлёт в amoCRM
4. Можно отвечать из amoCRM, ответы придут в бот через Wahelp webhook

**Плюсы:**
- ✅ Уже есть инфраструктура (Wahelp)
- ✅ Полный контроль над логикой бота
- ✅ Можно обрабатывать сообщения И отправлять в amoCRM
- ✅ Ответы из amoCRM приходят в бот

**Минусы:**
- Нужно добавить код для отправки в Wahelp

---

### Вариант 2: Восстановить встроенную интеграцию amoCRM

Отключить обработку сообщений вашим кодом, использовать только прокси amoCRM.

**Проблема:**
- Ваш код не будет работать (бонусы, заказы и т.д.)
- Не подходит, если нужна ваша логика

---

### Вариант 3: Отправлять напрямую в amoCRM через API

Использовать API amoCRM для отправки сообщений.

**Проблема:**
- Сложнее настройка
- Нужны credentials для API amoCRM
- Нужно искать контакт по телефону/TG ID

---

## Что нужно сделать сейчас

### Добавить отправку в Wahelp:

1. **Скопировать модуль Wahelp** из админ-бота (`tgbot-v1/crm/`)
2. **Добавить отправку сообщений** при получении от клиентов
3. **Настроить переменные окружения** для Wahelp API
4. **Протестировать** отправку сообщений

### Код для добавления:

```python
# При получении сообщения от клиента
@dp.message(F.text)
async def handle_client_message(message: Message, state: FSMContext):
    client = await get_client_by_tg(message.from_user.id)
    if client and client.get("phone"):
        # Отправляем в Wahelp
        await send_to_wahelp(
            phone=client["phone"],
            name=client.get("full_name") or client.get("name"),
            text=message.text,
            channel="clients_tg"
        )
    # Ваша логика обработки
    ...
```

---

## Вопросы для уточнения:

1. **Есть ли у клиентского бота доступ к Wahelp API?**
   - Нужны переменные окружения: `WAHELP_LOGIN`, `WAHELP_PASSWORD` или `WAHELP_ACCESS_TOKEN`
   - Нужны: `WAHELP_CLIENTS_PROJECT_ID` и `WAHELP_CLIENTS_CHANNEL_UUID`

2. **Используется ли тот же Wahelp аккаунт?**
   - Или нужен отдельный для клиентского бота?

3. **Нужно ли отправлять ВСЕ сообщения в amoCRM?**
   - Или только вопросы/заказы?
   - Или все текстовые сообщения от клиентов?

