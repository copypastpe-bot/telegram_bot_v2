# Как работают Telegram боты и интеграция с amoCRM

## Как работают Telegram боты

### Два способа работы бота:

1. **Long Polling (опрос)** — бот постоянно спрашивает у Telegram: "Есть ли новые сообщения?"
   - Используется: `await dp.start_polling(bot)`
   - Бот сам запрашивает обновления
   - Работает на любом сервере, не нужен публичный URL

2. **Webhook (вебхук)** — Telegram сам отправляет сообщения на ваш сервер
   - Нужен публичный URL (например, `https://yourdomain.com/webhook`)
   - Telegram отправляет POST-запросы при каждом сообщении
   - Быстрее, но нужен домен и SSL-сертификат

### Как бот получает сообщения:

```
Клиент → Telegram → Ваш бот (обработка) → Ответ клиенту
```

---

## Интеграция amoCRM с Telegram ботами

### Встроенная интеграция amoCRM (стандартная):

amoCRM имеет встроенную интеграцию с Telegram ботами. Она работает так:

1. **Вы подключаете бота в настройках amoCRM**
   - Указываете токен бота
   - amoCRM создаёт прокси-сервер

2. **Как это работает:**
   ```
   Клиент → Telegram → amoCRM прокси → amoCRM (показывает в интерфейсе)
   ```

3. **Особенности:**
   - Все сообщения автоматически попадают в чат с контактом в amoCRM
   - Можно отвечать прямо из amoCRM
   - НО: бот не обрабатывает сообщения сам (нет вашего кода)

---

## Почему перестало работать?

### Проблема:

Когда вы добавили свой бэкенд (`telegram-bot-client`), бот начал обрабатывать сообщения сам:

```python
@dp.message(StateFilter(ClientRequestFSM.waiting_question))
async def handle_question_text(message: Message, state: FSMContext):
    # Ваш код обрабатывает сообщение
    await notify_admins(payload)  # Отправляет админам
    # НО сообщение НЕ попадает в amoCRM!
```

**Что происходит:**
- Бот получает сообщение через `aiogram`
- Ваш код обрабатывает его
- Сообщение НЕ пересылается в amoCRM (потому что бот не проксирует)

### Почему раньше работало:

Когда бот был подключен только через встроенную интеграцию amoCRM:
- amoCRM получала все сообщения напрямую
- Показывала их в интерфейсе
- Можно было отвечать из amoCRM

---

## Решения

### Вариант 1: Отправлять сообщения в amoCRM через API (рекомендуется)

Добавить отправку сообщений в amoCRM при получении сообщения от клиента:

```python
@dp.message(StateFilter(ClientRequestFSM.waiting_question))
async def handle_question_text(message: Message, state: FSMContext):
    # Ваш код обработки
    await notify_admins(payload)
    
    # ДОБАВИТЬ: Отправка в amoCRM через API
    client = await get_client_by_tg(message.from_user.id)
    if client:
        await send_to_amocrm(client["id"], message.text)
```

**Плюсы:**
- Полный контроль над логикой бота
- Можно обрабатывать сообщения и отправлять в amoCRM
- Гибкость в настройке

**Минусы:**
- Нужно настроить API amoCRM
- Нужно найти контакт по телефону/TG ID

---

### Вариант 2: Использовать Wahelp как прокси

У вас уже есть интеграция с Wahelp. Можно использовать её:

1. **Сообщения из бота → Wahelp → amoCRM**
2. Wahelp уже интегрирован с amoCRM
3. Нужно настроить отправку сообщений в Wahelp

**Плюсы:**
- Уже есть инфраструктура
- Wahelp управляет интеграцией с amoCRM

**Минусы:**
- Дополнительный слой (Wahelp)
- Нужно настроить отправку в Wahelp

---

### Вариант 3: Двойная обработка (ваш код + amoCRM)

Настроить бота так, чтобы сообщения обрабатывались И вашим кодом, И попадали в amoCRM:

1. **Настроить webhook в Telegram** на ваш сервер
2. **Обработать сообщение** вашим кодом
3. **Переслать сообщение** в amoCRM через API

**Плюсы:**
- И ваша логика работает, и amoCRM получает сообщения
- Можно отвечать из amoCRM

**Минусы:**
- Сложнее настройка
- Нужно синхронизировать ответы

---

## Что нужно сделать сейчас

### Проверить:

1. **Как сейчас настроен бот в amoCRM?**
   - Зайти в настройки интеграций amoCRM
   - Проверить, подключен ли бот
   - Проверить статус интеграции

2. **Какой способ интеграции используется?**
   - Встроенная интеграция (прокси amoCRM)?
   - Или через API?

3. **Есть ли у вас доступ к API amoCRM?**
   - Нужны credentials для API
   - Или используете Wahelp?

---

## Рекомендация

**Использовать Wahelp как прокси:**

1. При получении сообщения от клиента в боте
2. Отправлять его в Wahelp через API
3. Wahelp автоматически перешлёт в amoCRM
4. Можно отвечать из amoCRM, ответы придут в бот через Wahelp

Это самый простой способ, так как у вас уже есть интеграция с Wahelp.

---

## Вопросы для уточнения:

1. Какой способ интеграции вы хотите использовать?
   - Через Wahelp (уже есть инфраструктура)
   - Напрямую через API amoCRM
   - Восстановить встроенную интеграцию amoCRM (но тогда ваш код не будет работать)

2. Есть ли у вас доступ к API amoCRM?
   - Client ID, Client Secret
   - Или используете только Wahelp?

3. Нужно ли, чтобы ответы из amoCRM приходили обратно в бот?
   - Или достаточно только отправки сообщений в amoCRM?

