# –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –±–æ—Ç–∞

## –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ª–æ–≥–∏–∫–µ

### 1. –ü—Ä–∏ /start

**–ë–´–õ–û:**
- –ò—Å–∫–∞–ª–∏ –∫–ª–∏–µ–Ω—Ç–∞ –≤ –ë–î
- –ü–æ–º–µ—á–∞–ª–∏ –∫–∞–∫ –ø–æ–¥–ø–∏—Å–∞–≤—à–µ–≥–æ—Å—è
- –ü–æ–∫–∞–∑—ã–≤–∞–ª–∏ —Ä–∞–∑–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞–ª–∏—á–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞

**–°–¢–ê–õ–û:**
- –ù–ï –∏—â–µ–º –∫–ª–∏–µ–Ω—Ç–∞ –≤ –ë–î
- –ù–ï –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ –ø–æ–¥–ø–∏—Å–∞–≤—à–µ–≥–æ—Å—è
- –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∑–∞–ø—Ä–æ—Å–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞

**–°–æ–æ–±—â–µ–Ω–∏–µ:**
```
–ü—Ä–∏–≤–µ—Ç! üëã

–≠—Ç–æ—Ç –±–æ—Ç –±—É–¥–µ—Ç –ø—Ä–∏—Å—ã–ª–∞—Ç—å –±–æ–Ω—É—Å—ã, –∞–∫—Ü–∏–∏ –∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ—Ç RaketaClean.

‚ö†Ô∏è –í–∞–∂–Ω–æ: –ß—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º, –Ω—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞.

–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –Ω–æ–º–µ—Ä–æ–º —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –µ–≥–æ –≤—Ä—É—á–Ω—É—é (—Ñ–æ—Ä–º–∞—Ç: 9XXXXXXXXX).
```

---

### 2. –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø–æ–¥–µ–ª–∏–ª—Å—è –Ω–æ–º–µ—Ä–æ–º

**–ß—Ç–æ –¥–µ–ª–∞–µ–º:**
1. –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω ‚Üí `phone` –∏ `phone_digits`
2. –ò—â–µ–º –∫–ª–∏–µ–Ω—Ç–∞ –≤ –ë–î –ø–æ `phone_digits`
3. **–ï—Å–ª–∏ –Ω–∞—à–ª–∏:**
   - –û–±–Ω–æ–≤–ª—è–µ–º `tg_id` = `bot_tg_user_id` = –ø–æ–ª—É—á–µ–Ω–Ω—ã–π `user.id`
   - –û–±–Ω–æ–≤–ª—è–µ–º `tg_user_id` = –ø–æ–ª—É—á–µ–Ω–Ω—ã–π `user.id`
   - –°—Ç–∞–≤–∏–º `bot_started = true`, `bot_started_at = now()`
   - –ù–∞—á–∏—Å–ª—è–µ–º 300 –±–æ–Ω—É—Å–æ–≤ —Å —Å–≥–æ—Ä–∞–Ω–∏–µ–º —á–µ—Ä–µ–∑ 30 –¥–Ω–µ–π (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –Ω–∞—á–∏—Å–ª—è–ª–∏)
   - **–ù–ï —Ç—Ä–æ–≥–∞–µ–º** `preferred_contact` (–æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å, –µ—Å–ª–∏ –±—ã–ª Wahelp - –æ—Å—Ç–∞–µ—Ç—Å—è Wahelp)
   - **–ù–ï —Ç—Ä–æ–≥–∞–µ–º** `wahelp_preferred_channel` (–æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å)
4. **–ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏:**
   - –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å –≤ `clients`
   - –ó–∞–ø–æ–ª–Ω—è–µ–º –≤—Å–µ –ø–æ–ª—è –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º
   - –ù–∞—á–∏—Å–ª—è–µ–º 300 –±–æ–Ω—É—Å–æ–≤

---

### 3. –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ù–ï –ø–æ–¥–µ–ª–∏–ª—Å—è –Ω–æ–º–µ—Ä–æ–º

**–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- ‚úÖ –ü—Ä–∞–π—Å (–∫–Ω–æ–ø–∫–∞ "üí∞ –ü—Ä–∞–π—Å")
- ‚úÖ –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã (–∫–Ω–æ–ø–∫–∞ "üïê –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã") - –¥–æ–±–∞–≤–∏—Ç—å —Ç—É–¥–∞ —Ç–µ–ª–µ–≥—Ä–∞–º –¥–ª—è –õ–°
- ‚úÖ –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å (–∫–Ω–æ–ø–∫–∞ "–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å")

**–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π:**
- –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–∞–ø–∏—Å–∞–ª –ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–∫—Ä–æ–º–µ –∫–Ω–æ–ø–æ–∫ –º–µ–Ω—é) ‚Üí —ç—Ç–æ "–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å"
- –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞–¥–º–∏–Ω–∞–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
- **–°–∫–ª–∞–¥—ã–≤–∞–µ–º –≤ —Ç–∞–±–ª–∏—Ü—É `leads`** (–µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç–∞ –Ω–µ—Ç –≤ –ë–î)

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ª–∏–¥–∞:**
- `name` - –∏–º—è –∏–∑ Telegram (`user.full_name` –∏–ª–∏ `user.username`)
- `phone` - NULL (–Ω–µ —É–∫–∞–∑–∞–Ω)
- `source` - "telegram_bot" –∏–ª–∏ "client_bot"
- `status` - "new"
- `tg_user_id` - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram (–µ—Å–ª–∏ –µ—Å—Ç—å –∫–æ–ª–æ–Ω–∫–∞)

---

### 4. –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

**–ù–ï —Å—Ç–∞–≤–∏–º –±–æ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–º –∫–∞–Ω–∞–ª–æ–º:**
- `preferred_contact` - –ù–ï –º–µ–Ω—è–µ–º (–æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å)
- `wahelp_preferred_channel` - –ù–ï –º–µ–Ω—è–µ–º (–æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å)
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–∑–∞–∫–∞–∑, –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è, –±–æ–Ω—É—Å—ã) –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç –∏–¥—Ç–∏ —á–µ—Ä–µ–∑ Wahelp

**–ó–∞–¥–∞—á–∞ –±–æ—Ç–∞:**
- –ü–æ–ª—É—á–∏—Ç—å –æ–∫–µ–π –Ω–∞ –ø–æ–¥–ø–∏—Å–∫—É (—Ç–µ–ª–µ—Ñ–æ–Ω)
- –ü–µ—Ä–µ–¥–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É (–≤–æ–ø—Ä–æ—Å—ã)
- –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é (–ø—Ä–∞–π—Å, —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã, –±–æ–Ω—É—Å—ã)

**–û–±—â–µ–Ω–∏–µ:**
- –û—Å—Ç–∞–µ—Ç—Å—è –≤ Wahelp (—á–µ—Ä–µ–∑ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞)
- –ë–æ—Ç –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ–±—â–µ–Ω–∏—è —Å –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º–∏

---

## –ß—Ç–æ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –≤ –∫–æ–¥–µ

### 1. `/start` handler

```python
@dp.message(CommandStart())
async def start_handler(message: Message, state: FSMContext) -> None:
    await state.clear()
    if not message.from_user:
        return
    
    # –ù–ï –∏—â–µ–º –∫–ª–∏–µ–Ω—Ç–∞, –ù–ï –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ –ø–æ–¥–ø–∏—Å–∞–≤—à–µ–≥–æ—Å—è
    # –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
    await message.answer(
        "–ü—Ä–∏–≤–µ—Ç! üëã\n\n"
        "–≠—Ç–æ—Ç –±–æ—Ç –±—É–¥–µ—Ç –ø—Ä–∏—Å—ã–ª–∞—Ç—å –±–æ–Ω—É—Å—ã, –∞–∫—Ü–∏–∏ –∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ—Ç RaketaClean.\n\n"
        "‚ö†Ô∏è <b>–í–∞–∂–Ω–æ:</b> –ß—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º, –Ω—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞.\n"
        "–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –Ω–æ–º–µ—Ä–æ–º —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –µ–≥–æ –≤—Ä—É—á–Ω—É—é (—Ñ–æ—Ä–º–∞—Ç: 9XXXXXXXXX).",
        reply_markup=main_menu(require_contact=True),
        parse_mode=ParseMode.HTML
    )
```

### 2. `upsert_contact` - —É–±—Ä–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–µ `preferred_contact` –∏ `wahelp_preferred_channel`

```python
# –£–ë–†–ê–¢–¨ —ç—Ç–∏ —Å—Ç—Ä–æ–∫–∏:
# "preferred_contact = 'bot'",
# "wahelp_preferred_channel = 'clients_tg'",

# –û–°–¢–ê–í–ò–¢–¨ —Ç–æ–ª—å–∫–æ:
# "bot_started = true",
# "bot_started_at = COALESCE(bot_started_at, now())",
```

### 3. Fallback handler - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

```python
@dp.message()
async def fallback(message: Message, state: FSMContext) -> None:
    if await state.get_state():
        await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≤–µ—Ä—à–∏—Ç–µ —Ç–µ–∫—É—â–∏–π —à–∞–≥ –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ ¬´–û—Ç–º–µ–Ω–∞¬ª.")
        return
    
    if not message.from_user:
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –∫–Ω–æ–ø–∫–æ–π –º–µ–Ω—é
    if is_menu_button(message.text):
        return  # –û–±—Ä–∞–±–æ—Ç–∞–µ—Ç—Å—è –¥—Ä—É–≥–∏–º handler'–æ–º
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    client = await get_client_by_tg(message.from_user.id)
    
    if needs_phone(client):
        # –ù–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞ - —ç—Ç–æ "–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å"
        # –°–æ–∑–¥–∞–µ–º –ª–∏–¥ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞–¥–º–∏–Ω—É
        await create_lead_and_notify_admin(message)
    else:
        # –ï—Å—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞–¥–º–∏–Ω—É –∫–∞–∫ –≤–æ–ø—Ä–æ—Å
        await notify_admin_about_question(message, client)
```

### 4. –î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é —Å–æ–∑–¥–∞–Ω–∏—è –ª–∏–¥–∞

```python
async def create_lead_and_notify_admin(message: Message) -> None:
    user = message.from_user
    pool = get_pool()
    async with pool.acquire() as conn:
        # –°–æ–∑–¥–∞–µ–º –ª–∏–¥
        lead = await conn.fetchrow(
            """
            INSERT INTO leads(name, phone, source, status, tg_user_id)
            VALUES ($1, NULL, 'telegram_bot', 'new', $2)
            RETURNING *
            """,
            user.full_name or user.username or "–ë–µ–∑ –∏–º–µ–Ω–∏",
            user.id
        )
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞–¥–º–∏–Ω–∞–º
        payload = format_admin_payload("–í–æ–ø—Ä–æ—Å –æ—Ç –ª–∏–¥–∞ (–±–µ–∑ —Ç–µ–ª–µ—Ñ–æ–Ω–∞)", message, None)
        await notify_admins(payload)
```

### 5. –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã - –¥–æ–±–∞–≤–∏—Ç—å —Ç–µ–ª–µ–≥—Ä–∞–º –¥–ª—è –õ–°

```python
@dp.message(F.text.casefold() == BTN_SCHEDULE.lower())
async def schedule_handler(message: Message) -> None:
    text = (
        "üïê <b>–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã:</b>\n\n"
        "–ü–Ω-–í—Å: 9:00 - 21:00\n\n"
        "–î–ª—è —Å–≤—è–∑–∏:\n"
        "Telegram: @your_telegram_username"
    )
    await message.answer(text, parse_mode=ParseMode.HTML)
```

---

## –í–æ–ø—Ä–æ—Å—ã –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è

1. **–ö–∞–∫–æ–µ –∏–º—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è —Ç–µ–ª–µ–≥—Ä–∞–º–∞ –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–±–æ—Ç—ã?**
   - @username –±–æ—Ç–∞?
   - –ò–ª–∏ –ª–∏—á–Ω—ã–π —Ç–µ–ª–µ–≥—Ä–∞–º –º–µ–Ω–µ–¥–∂–µ—Ä–∞?

2. **–ß—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —É–∂–µ –µ—Å—Ç—å –≤ –ë–î, –Ω–æ –±–µ–∑ —Ç–µ–ª–µ—Ñ–æ–Ω–∞?**
   - –û–±–Ω–æ–≤–ª—è—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞?
   - –ò–ª–∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å –ª–∏–¥–∞?

3. **–ù—É–∂–Ω–æ –ª–∏ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –ª–∏–¥–æ–≤?**
   - –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ —á–∞—Ç?
   - –ò–ª–∏ —Ç–æ–ª—å–∫–æ –≤ –ë–î?

